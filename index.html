<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Symptom & Lifestyle Journal — Clinic Edition (Full)</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <style>
    :root{ --bg:#f7f7fb; --fg:#111; --muted:#6b6b6b; --card:#fff; --border:#e6e6ef; --accent:#2f6fed; --accent-ghost:#e8efff; --danger:#d23d3d }
    *{box-sizing:border-box} html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);padding:12px 16px;z-index:10;display:flex;align-items:center;gap:12px}
    header .logo{width:32px;height:32px;border:1px dashed var(--border);border-radius:4px;display:inline-block;background:#fafafa}
    header h1{margin:0;font-size:18px} header small{color:var(--muted)}
    main{max-width:1040px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px}
    .grid{display:grid;gap:12px}
    @media(min-width:980px){ .grid-2{grid-template-columns:1fr 1fr} .grid-3{grid-template-columns:1fr 1fr 1fr} .grid-4{grid-template-columns:1fr 1fr 1fr 1fr} }
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;color:#111;font-size:14px}
    textarea{min-height:88px;resize:vertical}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn-ghost{background:var(--accent-ghost);border-color:transparent;color:#214ec7}
    .btn-danger{background:#fff;border-color:var(--danger);color:#d23d3d}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse} th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left;font-size:13px;vertical-align:top}
    th{font-size:12px;color:var(--muted)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--accent-ghost);color:#214ec7;font-size:12px}
    .token{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;margin:2px 4px 0 0;font-size:12px}
    .footer{font-size:12px;color:var(--muted);text-align:center;padding:16px}
    details summary{cursor:pointer}
  </style>
</head>
<body>
  <header>
    <div class="logo" title="Your clinic logo here"></div>
    <div>
      <h1>Symptom & Lifestyle Journal — Clinic Edition</h1>
      <small class="muted">Diet · Lifestyle · Symptoms · Meds/Supps · Scales</small>
    </div>
  </header>
  <main>
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <div><span class="pill" id="status-pill">Local only</span></div>
        <div class="row">
          <button class="btn btn-ghost" id="installBtn" style="display:none">Install App</button>
          <button class="btn" id="exportDaysBtn">Export days.csv</button>
          <button class="btn" id="exportSymptomsBtn">Export symptoms.csv</button>
          <button class="btn" id="exportScalesBtn">Export scales.csv</button>
          <button class="btn" id="syncBtn">Sync to Clinic</button>
          <button class="btn btn-danger" id="clearLocalBtn">Clear Local Data</button>
        </div>
      </div>
      <p class="muted" style="margin-top:8px">Data stays on this device unless you sync to your clinic. Use de-identified codes (no names/MRNs).</p>
      <details style="margin-top:6px">
        <summary><strong>Consent & Privacy (placeholder text)</strong></summary>
        <p class="muted">
          By tapping “Sync to Clinic,” I consent to share my entries (diet, lifestyle, symptoms, medications, supplements, and scales)
          with my clinician. This app is informational and not a substitute for medical care or emergencies. I understand that
          entries are stored locally on my device until I choose to sync. I can delete local entries at any time.
        </p>
      </details>
    </section>

    <section class="card">
      <h3>Daily Lifestyle</h3>
      <div class="grid grid-3">
        <div><label for="date">Date</label><input type="date" id="date"></div>
        <div><label for="consent">Consent to share</label><select id="consent"><option value="no">No</option><option value="yes">Yes</option></select></div>
        <div><label for="webhook">Clinic Webhook (https)</label><input type="url" id="webhook" placeholder="https://your-n8n/webhook/xyz"></div>
      </div>
      <div class="grid grid-2" style="margin-top:8px">
        <div><label for="meals">Diet (type naturally)</label><textarea id="meals" placeholder="e.g., Fairlife strawberry milk 14oz; Taco Bell nachos; aged cheese; red wine. "></textarea></div>
        <div><label for="notes">Notes (symptoms, travel, cycle, etc.)</label><textarea id="notes"></textarea></div>
      </div>
      <div class="grid grid-2" style="margin-top:8px">
        <div><label for="medications_text">Medications (free text)</label><textarea id="medications_text" placeholder="ibuprofen 400 mg at 2pm; sumatriptan at onset; propranolol PM"></textarea></div>
        <div><label for="supplements_text">Supplements (free text)</label><textarea id="supplements_text" placeholder="magnesium glycinate 200 mg bedtime; omega-3; CoQ10"></textarea></div>
      </div>
      <div class="grid grid-2" style="margin-top:8px">
        <div><label for="medications_time">Medication timing</label>
          <select id="medications_time"><option value="">—</option><option>AM</option><option>PM</option><option>Bedtime</option><option>Onset</option></select></div>
        <div><label for="supplements_time">Supplement timing</label>
          <select id="supplements_time"><option value="">—</option><option>AM</option><option>PM</option><option>Bedtime</option></select></div>
      </div>
      <div class="grid grid-4" style="margin-top:8px">
        <div><label for="activity_minutes">Activity Minutes</label><input type="number" id="activity_minutes" min="0" step="1"></div>
        <div><label for="steps">Steps</label><input type="number" id="steps" min="0" step="1"></div>
        <div><label for="intensity">Intensity</label><select id="intensity"><option value="">—</option><option>Light</option><option>Moderate</option><option>Vigorous</option></select></div>
        <div><label for="hydration_liters">Hydration (L)</label><input type="number" id="hydration_liters" min="0" step="0.1"></div>
      </div>
      <div class="grid grid-4" style="margin-top:8px">
        <div><label for="sleep_hours">Sleep Hours</label><input type="number" id="sleep_hours" min="0" step="0.1"></div>
        <div><label for="sleep_quality">Sleep Quality (1–5)</label><input type="number" id="sleep_quality" min="1" max="5" step="1"></div>
        <div><label for="bedtime">Bedtime</label><input type="time" id="bedtime"></div>
        <div><label for="waketime">Waketime</label><input type="time" id="waketime"></div>
      </div>
      <div class="grid grid-4" style="margin-top:8px">
        <div><label for="stress">Stress (1–10)</label><input type="number" id="stress" min="1" max="10" step="1"></div>
        <div><label for="mood">Mood (1–5)</label><input type="number" id="mood" min="1" max="5" step="1"></div>
        <div><label for="caff_after_2pm">Caffeine after 2pm (count)</label><input type="number" id="caff_after_2pm" min="0" step="1" placeholder="0"></div>
        <div><label for="late_meal">Late meal/snack ≤2h before bed</label><select id="late_meal"><option value="">—</option><option>No</option><option>Yes</option></select></div>
      </div>
      <div class="grid grid-4" style="margin-top:8px">
        <div><label for="screen_evening">Screen time in last 2h (hours)</label><input type="number" id="screen_evening" min="0" step="0.1"></div>
        <div><label for="rhr">Resting HR (optional)</label><input type="number" id="rhr" min="0" step="1"></div>
        <div><label for="hrv">HRV (ms, optional)</label><input type="number" id="hrv" min="0" step="1"></div>
        <div><label for="menstrual_phase">Menstrual Phase</label>
          <select id="menstrual_phase"><option value="">N/A</option><option>Follicular</option><option>Ovulation</option><option>Luteal</option><option>Premenstrual</option><option>Menstruation</option></select></div>
      </div>
    </section>

    <section class="card">
      <h3>Symptoms (add any)</h3>
      <div class="grid grid-3">
        <div><label for="symptom_name">Symptom</label><input type="text" id="symptom_name" placeholder="e.g., headache, joint pain, fatigue"></div>
        <div><label for="symptom_severity">Severity (0–10)</label><input type="number" id="symptom_severity" min="0" max="10"></div>
        <div><label for="symptom_duration">Duration (hours)</label><input type="number" id="symptom_duration" step="0.1" min="0"></div>
      </div>
      <div class="grid grid-2" style="margin-top:8px">
        <div><label for="symptom_tags">Tags (comma separated)</label><input type="text" id="symptom_tags" placeholder="e.g., unilateral, morning, post-workout"></div>
        <div><label for="symptom_notes">Symptom notes</label><input type="text" id="symptom_notes" placeholder="anything notable about this symptom"></div>
      </div>
      <div class="row" style="margin-top:8px"><button class="btn" id="addSymptomBtn">Add symptom to today</button></div>
      <div id="symptomTokens" style="margin-top:6px"></div>

      <div class="row" style="margin-top:12px">
        <button class="btn btn-primary" id="saveDayBtn">Save Day</button>
        <button class="btn" id="newDayBtn">New</button>
      </div>
    </section>

    <section class="card">
      <h3>Quick Micro-Scales</h3>
      <details>
        <summary>PSS-4 (weekly)</summary>
        <div class="grid grid-2" style="margin-top:8px">
          <div><label>Unable to control important things?</label><select class="pss4"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option></select></div>
          <div><label>Confident to handle problems? (reverse)</label><select class="pss4"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option></select></div>
          <div><label>Things going your way? (reverse)</label><select class="pss4"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option></select></div>
          <div><label>Could not overcome difficulties?</label><select class="pss4"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option></select></div>
        </div>
        <div class="row" style="margin-top:8px"><button class="btn" id="savePSS4">Save PSS-4</button></div>
      </details>
      <details style="margin-top:8px">
        <summary>PHQ-2 (weekly)</summary>
        <div class="grid grid-2" style="margin-top:8px">
          <div><label>Little interest/pleasure in doing things</label><select class="phq2"><option>0</option><option>1</option><option>2</option><option>3</option></select></div>
          <div><label>Down, depressed, or hopeless</label><select class="phq2"><option>0</option><option>1</option><option>2</option><option>3</option></select></div>
        </div>
        <div class="row" style="margin-top:8px"><button class="btn" id="savePHQ2">Save PHQ-2</button></div>
      </details>
      <details style="margin-top:8px">
        <summary>PEG-3 Pain (weekly)</summary>
        <div class="grid grid-3" style="margin-top:8px">
          <div><label>Average pain (0–10)</label><input type="number" class="peg3" min="0" max="10"></div>
          <div><label>Pain interference – enjoyment</label><input type="number" class="peg3" min="0" max="10"></div>
          <div><label>Pain interference – activity</label><input type="number" class="peg3" min="0" max="10"></div>
        </div>
        <div class="row" style="margin-top:8px"><button class="btn" id="savePEG3">Save PEG-3</button></div>
      </details>
    </section>

    <section class="card">
      <h3>Your Days</h3>
      <div id="entries"></div>
    </section>

    <section class="card">
      <h3>Clinician Settings</h3>
      <div class="grid grid-3">
        <div><label for="clinic_name">Clinic Name</label><input type="text" id="clinic_name" placeholder="Your Clinic Name (placeholder)"></div>
        <div><label for="min_days">Min days to analyze</label><input type="number" id="min_days" value="7" min="1"></div>
        <div><label for="export_id">De-ID Patient Code</label><input type="text" id="export_id" placeholder="ABC123"></div>
      </div>
      <p class="muted">Saved locally and included in exports/sync payloads.</p>
    </section>
  </main>
  <div class="footer">Informational tool only. Not for emergencies or diagnosis.</div>

  <script>
    let deferredPrompt; const installBtn=document.getElementById('installBtn');
    window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;installBtn.style.display='inline-block';});
    installBtn?.addEventListener('click', async ()=>{ if(!deferredPrompt)return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.style.display='none'; });

    const dayKey='ce.days.full.v1'; const symptomKey='ce.symptoms.v1'; const scalesKey='ce.scales.v1'; const settingsKey='ce.settings.v1';
    const $=id=>document.getElementById(id); const statusPill=$('status-pill');
    function load(key){ try{return JSON.parse(localStorage.getItem(key)||'[]')}catch(e){return[]} }
    function save(key,val){ localStorage.setItem(key, JSON.stringify(val)) }
    function loadSettings(){ try{return JSON.parse(localStorage.getItem(settingsKey)||'{}')}catch(e){return{}} }
    function saveSettings(s){ localStorage.setItem(settingsKey, JSON.stringify(s)) }
    function settingsFromUI(){ const s={clinic_name:$('clinic_name').value.trim(),min_days:Number($('min_days').value||7),export_id:$('export_id').value.trim()}; saveSettings(s); return s; }
    function applySettings(){ const s=loadSettings(); if(s.clinic_name)$('clinic_name').value=s.clinic_name; if(s.min_days)$('min_days').value=s.min_days; if(s.export_id)$('export_id').value=s.export_id; }

    function any(t, arr){ return arr.some(w=>t.includes(w)) }

    function tagDiet(text){
      const t=(text||'').toLowerCase(); const tags=new Set();
      if(any(t,['fairlife','milk','cheese','yogurt','ice cream','kefir','aged'])) tags.add('dairy');
      if(any(t,['aged cheese','blue cheese','gouda','parmesan'])) tags.add('aged_cheese');
      if(any(t,['wine','red wine','white wine','beer','vodka','whiskey','alcohol'])) tags.add('alcohol');
      if(any(t,['taco bell','mcdonald','kfc','burger king','wendy','popeyes','domino','pizza hut','chipotle','subway'])) tags.add('fast_food');
      if(any(t,['fried','fries','breaded'])) tags.add('fried');
      if(any(t,['spicy','jalapeno','hot sauce','chili'])) tags.add('spicy');
      if(any(t,['chocolate','cocoa'])) tags.add('chocolate');
      if(any(t,['nitrate','nitrite','deli','bacon','salami','pepperoni','hot dog'])) tags.add('processed_meat');
      if(any(t,['aspartame','acesulfame','sucralose','diet soda','stevia'])) tags.add('artificial_sweetener');
      if(any(t,['soda','cola','energy drink','monster','red bull','sweet tea'])) tags.add('sugary_drink');
      if(any(t,['nacho','chips','candy','cookie','ultra-processed','ultra processed','packaged'])) tags.add('ultra_processed');
      if(any(t,['coffee','espresso','latte','cappuccino','red bull','energy'])) tags.add('caffeine');
      if(any(t,['bread','pasta','wheat','cracker','flour','gluten'])) tags.add('gluten');
      if(any(t,['vinegar','sauerkraut','kimchi','kombucha','yogurt'])) tags.add('fermented');
      return Array.from(tags);
    }
    function tagMeds(text){
      const t=(text||'').toLowerCase(); const tags=new Set();
      const add=(words,label)=>{ if(words.some(w=>t.includes(w))) tags.add(label); };
      add(['ibuprofen','advil','motrin','naproxen','aleve','diclofenac','meloxicam'],'med_nsaid');
      add(['acetaminophen','paracetamol','tylenol','apap'],'med_acetaminophen');
      add(['sumatriptan','rizatriptan','zolmitriptan','eletriptan','frovatriptan'],'med_triptan');
      add(['ubrogepant','rimegepant','atogepant'],'med_gepant');
      add(['erenumab','galcanezumab','fremanezumab','eptinezumab'],'med_cgrp_mab');
      add(['propranolol','metoprolol','atenolol'],'med_beta_blocker');
      add(['amitriptyline','nortriptyline'],'med_tca');
      add(['topiramate','valproate','divalproex'],'med_antiepileptic');
      add(['sertraline','fluoxetine','escitalopram','citalopram'],'med_ssri');
      add(['venlafaxine','duloxetine'],'med_snri');
      add(['tizanidine','cyclobenzaprine','baclofen','methocarbamol'],'med_muscle_relaxant');
      add(['cetirizine','zyrtec','loratadine','claritin','fexofenadine','allegra','diphenhydramine','benadryl'],'med_antihistamine');
      add(['pseudoephedrine','phenylephrine'],'med_decongestant');
      add(['caffeine','excedrin'],'med_caffeine');
      add(['ondansetron','zofran','metoclopramide','reglan'],'med_antiemetic');
      return Array.from(tags);
    }
    function tagSupps(text){
      const t=(text||'').toLowerCase(); const tags=new Set();
      const add=(words,label)=>{ if(words.some(w=>t.includes(w))) tags.add(label); };
      add(['magnesium'],'supp_magnesium');
      add(['riboflavin','b2'],'supp_riboflavin');
      add(['coq10','co-enzyme q10','coenzyme q10'],'supp_coq10');
      add(['omega-3','fish oil','epa','dha'],'supp_omega3');
      add(['melatonin'],'supp_melatonin');
      add(['creatine'],'supp_creatine');
      add(['turmeric','curcumin'],'supp_curcumin');
      add(['ashwagandha'],'supp_ashwagandha');
      return Array.from(tags);
    }
    function parseDose(text){
      if(!text) return {val:null, unit:''};
      const m = text.toLowerCase().match(/(\d+(?:\.\d+)?)\s*(mg|g|mcg|iu|capsules?|tabs?|tablets?)/);
      if(m){ return {val: parseFloat(m[1]), unit: m[2]} }
      return {val:null, unit:''};
    }
    function computeSleepScore(d){
      let score=100; const h=parseFloat(d.sleep_hours||''); const q=parseInt(d.sleep_quality||'');
      if(!isNaN(h)){ if(h<7) score-=10; else if(h>=7 && h<7.5) score-=5; else if(h>9.5) score-=10; }
      if(!isNaN(q)){ if(q<=2) score-=10; else if(q===3) score-=5; }
      const days=(JSON.parse(localStorage.getItem('ce.days.full.v1')||'[]')).slice(-7);
      function timeToMin(x){ if(!x) return null; const [hh,mm]=x.split(':').map(n=>parseInt(n,10)); return hh*60+(mm||0); }
      const btmins=days.map(x=>timeToMin(x.bedtime)).filter(v=>v!==null); const curbt=timeToMin(d.bedtime);
      if(curbt!=null && btmins.length>=3){ const sorted=btmins.slice().sort((a,b)=>a-b); const med=sorted[Math.floor(sorted.length/2)]; const diff=Math.abs(curbt-med); if(diff>90) score-=8; else if(diff>=60) score-=4; }
      const caf=parseInt(d.caff_after_2pm||'0'); if(!isNaN(caf)){ if(caf>=2) score-=10; else if(caf>=1) score-=6; }
      if((d.late_meal||'').toLowerCase()==='yes') score-=6;
      const scr=parseFloat(d.screen_evening||''); if(!isNaN(scr)){ if(scr>1) score-=4; }
      if(score<0) score=0; if(score>100) score=100; return score;
    }
    let todaySymptoms=[];
    function renderTokens(){
      const box=document.getElementById('symptomTokens'); box.innerHTML='';
      if(todaySymptoms.length===0){ box.innerHTML='<span class="muted">No symptoms added yet for this day.</span>'; return; }
      todaySymptoms.forEach((s,idx)=>{
        const el=document.createElement('span'); el.className='token'; el.textContent=`${s.name} • sev ${s.severity||0}/10 • ${s.duration||0}h`;
        el.title=(s.tags?('Tags: '+s.tags):'')+(s.notes?(' | '+s.notes):'');
        el.onclick=()=>{ todaySymptoms.splice(idx,1); renderTokens(); };
        box.appendChild(el);
      });
    }
    function resetDayForm(){
      ['meals','notes','medications_text','supplements_text','medications_time','supplements_time','activity_minutes','steps','intensity','hydration_liters','sleep_hours','sleep_quality','bedtime','waketime','stress','mood','caff_after_2pm','late_meal','screen_evening','rhr','hrv','menstrual_phase'].forEach(id=>{ const el=document.getElementById(id); if(!el) return; if(el.tagName==='SELECT') el.value=''; else el.value=''; });
      todaySymptoms=[]; renderTokens();
    }
    function saveDay(){
      const date=$('date').value; if(!date){ alert('Choose a date.'); return; }
      const settings = loadSettings();
      const meals = $('meals').value.trim();
      const meds = $('medications_text').value.trim();
      const supps = $('supplements_text').value.trim();
      const dose = parseDose(meds);
      const day = {
        date, consent:$('consent').value, webhook:$('webhook').value.trim(),
        meals, notes:$('notes').value.trim(),
        medications_text: meds, supplements_text: supps,
        medications_time: $('medications_time').value, supplements_time: $('supplements_time').value,
        activity_minutes:$('activity_minutes').value, steps:$('steps').value, intensity:$('intensity').value, hydration_liters:$('hydration_liters').value,
        sleep_hours:$('sleep_hours').value, sleep_quality:$('sleep_quality').value, bedtime:$('bedtime').value, waketime:$('waketime').value,
        stress:$('stress').value, mood:$('mood').value, caff_after_2pm:$('caff_after_2pm').value, late_meal:$('late_meal').value, screen_evening:$('screen_evening').value,
        rhr:$('rhr').value, hrv:$('hrv').value, menstrual_phase:$('menstrual_phase').value,
        diet_tags: tagDiet(meals).join('|'),
        med_tags: tagMeds(meds).join('|'),
        supp_tags: tagSupps(supps).join('|'),
        med_dose_val: dose.val, med_dose_unit: dose.unit,
        sleep_score: 0,
        settings, created_at:new Date().toISOString()
      };
      day.sleep_score = computeSleepScore(day);
      const days = load(dayKey).filter(d=>d.date!==date); days.push(day); save(dayKey, days);
      const syms = load(symptomKey).filter(s=>s.date!==date);
      todaySymptoms.forEach(s=>{ syms.push({ date, export_id: settings?.export_id||'', name:s.name, severity:s.severity, duration:s.duration, tags:s.tags, notes:s.notes, created_at:new Date().toISOString() }); });
      save(symptomKey, syms);
      renderEntries(); resetDayForm();
    }
    function renderEntries(){
      const days = load(dayKey).sort((a,b)=>(a.date||'').localeCompare(b.date));
      const syms = load(symptomKey);
      const div=document.getElementById('entries');
      if(days.length===0){ div.innerHTML='<p class="muted">No days saved yet.</p>'; return; }
      let html='<table><thead><tr><th>Date</th><th>Lifestyle</th><th>Meds/Supps</th><th>Sleep/Score</th><th>Symptoms</th><th>Tags</th><th></th></tr></thead><tbody>';
      for(const d of days){
        const symForDay = syms.filter(s=>s.date===d.date);
        const symStr = symForDay.length ? symForDay.map(s=>`${s.name} (${s.severity||''}/10, ${s.duration||0}h)`).join(', ') : '—';
        html += `<tr>
          <td><div>${d.date}</div><div class="muted" style="font-size:11px">${d.settings?.export_id||''}</div></td>
          <td>${(d.meals||'').replace(/\n/g,'<br>')}<br><span class="muted">${d.activity_minutes||''}m • ${d.steps||''} steps • ${d.intensity||''} • H2O ${d.hydration_liters||''}L</span></td>
          <td><div><strong>Meds:</strong> ${(d.medications_text||'—').replace(/\n/g,'<br>')} <span class="muted">(${d.medications_time||'—'})</span></div>
              <div><strong>Supps:</strong> ${(d.supplements_text||'—').replace(/\n/g,'<br>')} <span class="muted">(${d.supplements_time||'—'})</span></div>
              <div class="muted">Dose parsed: ${d.med_dose_val||''} ${d.med_dose_unit||''}</div></td>
          <td>${d.sleep_hours||''}h Q${d.sleep_quality||''} • Bed ${d.bedtime||''} • Score <strong>${d.sleep_score}</strong><br><span class="muted">Stress ${d.stress||''}/10 • Mood ${d.mood||''}/5 • Caff-after-2pm ${d.caff_after_2pm||0} • Late meal ${d.late_meal||''} • Screen ${d.screen_evening||''}h</span></td>
          <td>${symStr}</td>
          <td><div><strong>Diet:</strong> ${(d.diet_tags||'').replace(/\|/g, ', ')||'—'}</div>
              <div><strong>Meds:</strong> ${(d.med_tags||'').replace(/\|/g, ', ')||'—'}</div>
              <div><strong>Supps:</strong> ${(d.supp_tags||'').replace(/\|/g, ', ')||'—'}</div></td>
          <td><button class="btn btn-danger" data-del="${d.date}">Delete</button></td>
        </tr>`;
      }
      html+='</tbody></table>'; div.innerHTML=html;
      div.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const date=btn.getAttribute('data-del');
          save(dayKey, load(dayKey).filter(d=>d.date!==date));
          save(symptomKey, load(symptomKey).filter(s=>s.date!==date));
          renderEntries();
        });
      });
    }
    function saveScale(name, payload){
      const arr = load(scalesKey);
      const rec = { date: $('date').value, export_id: (loadSettings()?.export_id||''), name, payload, created_at:new Date().toISOString() };
      arr.push(rec); save(scalesKey, arr); alert(name+' saved.');
    }
    document.addEventListener('click', (e)=>{
      if(e.target && e.target.id==='savePSS4'){
        const vals=[...document.querySelectorAll('.pss4')].map(x=>parseInt(x.value||'0')); const scored=[vals[0], 4-vals[1], 4-vals[2], vals[3]]; const total=scored.reduce((a,b)=>a+b,0); saveScale('PSS-4', {items: vals, total});
      }
      if(e.target && e.target.id==='savePHQ2'){
        const vals=[...document.querySelectorAll('.phq2')].map(x=>parseInt(x.value||'0')); const total=vals.reduce((a,b)=>a+b,0); saveScale('PHQ-2', {items: vals, total});
      }
      if(e.target && e.target.id==='savePEG3'){
        const vals=[...document.querySelectorAll('.peg3')].map(x=>parseInt(x.value||'0')); const mean = vals.filter(v=>!isNaN(v)).reduce((a,b)=>a+b,0) / (vals.filter(v=>!isNaN(v)).length||1); saveScale('PEG-3', {items: vals, mean});
      }
    });
    function toCSVDays(){
      const days=load(dayKey);
      const headers=["date","consent","clinic_name","export_id","meals","notes","medications_text","supplements_text","medications_time","supplements_time","med_dose_val","med_dose_unit","activity_minutes","steps","intensity","hydration_liters","sleep_hours","sleep_quality","bedtime","waketime","stress","mood","caff_after_2pm","late_meal","screen_evening","rhr","hrv","menstrual_phase","diet_tags","med_tags","supp_tags","sleep_score","created_at"];
      const out=[headers.join(",")];
      for(const d of days){
        const row=[d.date||"", d.consent||"", d.settings?.clinic_name||"", d.settings?.export_id||"", (d.meals||"").replace(/"/g,'""'), (d.notes||"").replace(/"/g,'""'), (d.medications_text||"").replace(/"/g,'""'), (d.supplements_text||"").replace(/"/g,'""'), d.medications_time||"", d.supplements_time||"", d.med_dose_val||"", d.med_dose_unit||"", d.activity_minutes||"", d.steps||"", d.intensity||"", d.hydration_liters||"", d.sleep_hours||"", d.sleep_quality||"", d.bedtime||"", d.waketime||"", d.stress||"", d.mood||"", d.caff_after_2pm||"", d.late_meal||"", d.screen_evening||"", d.rhr||"", d.hrv||"", d.menstrual_phase||"", d.diet_tags||"", d.med_tags||"", d.supp_tags||"", d.sleep_score||"", d.created_at||""];
        out.push(row.map(v=>`"${String(v)}"`).join(","));
      }
      return out.join("\n");
    }
    function toCSVSymptoms(){
      const syms=load(symptomKey);
      const headers=["date","export_id","name","severity","duration","tags","notes","created_at"];
      const out=[headers.join(",")];
      for(const s of syms){
        const row=[s.date||"", s.export_id||"", (s.name||"").replace(/"/g,'""'), s.severity||"", s.duration||"", (s.tags||"").replace(/"/g,'""'), (s.notes||"").replace(/"/g,'""'), s.created_at||""].map(v=>`"${String(v)}"`).join(",");
        out.push(row);
      }
      return out.join("\n");
    }
    function toCSVScales(){
      const arr=load(scalesKey);
      const headers=["date","export_id","name","payload_json","created_at"];
      const out=[headers.join(",")];
      for(const r of arr){
        const payload = JSON.stringify(r.payload||{}).replace(/"/g,'""');
        const row=[r.date||"", r.export_id||"", r.name||"", payload, r.created_at||""].map(v=>`"${String(v)}"`).join(",");
        out.push(row);
      }
      return out.join("\n");
    }
    function download(filename, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'text/csv'})); a.download=filename; a.click(); URL.revokeObjectURL(a.href); }
    async function syncToWebhook(){
      const days=load(dayKey); const syms=load(symptomKey); const scales=load(scalesKey);
      const webhook=$('webhook').value.trim(); const consent=$('consent').value;
      if(!webhook){alert('Enter clinic webhook URL first.');return;}
      if(consent!=='yes'){alert('Consent must be Yes to sync.');return;}
      statusPill.textContent='Syncing…';
      try{
        const res=await fetch(webhook,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({days, symptoms: syms, scales, exported_at:new Date().toISOString()})});
        if(!res.ok) throw new Error('HTTP '+res.status);
        statusPill.textContent='Synced'; statusPill.style.background='#e7f8ed';
      }catch(err){ alert('Sync failed: '+err.message); statusPill.textContent='Local only'; statusPill.style.background=''; }
    }
    (function init(){
      $('date').valueAsDate=new Date();
      document.getElementById('addSymptomBtn').addEventListener('click', ()=>{
        const s={name:$('symptom_name').value.trim(), severity:$('symptom_severity').value, duration:$('symptom_duration').value, tags:$('symptom_tags').value.trim(), notes:$('symptom_notes').value.trim()};
        if(!s.name){ alert('Enter a symptom name.'); return; } todaySymptoms.push(s);
        ['symptom_name','symptom_severity','symptom_duration','symptom_tags','symptom_notes'].forEach(id=>$(id).value=''); renderTokens();
      });
      document.getElementById('saveDayBtn').addEventListener('click', saveDay);
      document.getElementById('newDayBtn').addEventListener('click', resetDayForm);
      document.getElementById('exportDaysBtn').addEventListener('click', ()=>{settingsFromUI(); download('days.csv', toCSVDays());});
      document.getElementById('exportSymptomsBtn').addEventListener('click', ()=>{settingsFromUI(); download('symptoms.csv', toCSVSymptoms());});
      document.getElementById('exportScalesBtn').addEventListener('click', ()=>{settingsFromUI(); download('scales.csv', toCSVScales());});
      document.getElementById('syncBtn').addEventListener('click', ()=>{settingsFromUI(); syncToWebhook();});
      document.getElementById('clearLocalBtn').addEventListener('click', ()=>{ if(confirm('Delete all local entries on this device?')){ localStorage.removeItem(dayKey); localStorage.removeItem(symptomKey); localStorage.removeItem(scalesKey); renderEntries(); statusPill.textContent='Local only'; statusPill.style.background=''; } });
      ['clinic_name','min_days','export_id'].forEach(id=>$(id).addEventListener('change', settingsFromUI));
      applySettings(); renderEntries();
      if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js'); }
      renderTokens();
    })();
  </script>
</body>
</html>
